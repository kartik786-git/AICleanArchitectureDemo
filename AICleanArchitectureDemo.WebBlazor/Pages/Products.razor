@page "/products"
@inject MediatR.IMediator Mediator
@inject NavigationManager Navigation
@inject AICleanArchitectureDemo.WebBlazor.Services.CartStateService CartState
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

<PageTitle>Products - Online Shopping</PageTitle>

<div class="container">
    <div class="row">
        <div class="col-12 text-center mb-4">
            <h1 class="display-4 fw-bold text-primary">
                <i class="fas fa-box me-3"></i>Our Products
            </h1>
            <p class="lead text-muted">Discover our amazing collection</p>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="row">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-filter me-2"></i>Filter by Category
                        </h5>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="@(selectedCategoryId == null ? "btn btn-primary" : "btn btn-outline-secondary")"
                                    @onclick="() => FilterByCategory(null)">
                                <i class="fas fa-th-large me-1"></i>All Categories
                            </button>
                            @foreach (var category in categories)
                            {
                                <button class="@(selectedCategoryId == category.Id ? "btn btn-primary" : "btn btn-outline-primary")"
                                        @onclick="() => FilterByCategory(category.Id)">
                                    @category.Name
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (!filteredProducts.Any())
        {
            <div class="row">
                <div class="col-12 text-center">
                    <div class="card shadow-sm">
                        <div class="card-body py-5">
                            <i class="fas fa-search fa-4x text-muted mb-3"></i>
                            <h3 class="text-muted">No products found</h3>
                            <p class="text-muted">Try selecting a different category or check back later.</p>
                            <button class="btn btn-primary" @onclick="() => FilterByCategory(null)">
                                <i class="fas fa-refresh me-2"></i>Show All Products
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="row">
                @foreach (var product in filteredProducts)
                {
                    <div class="col-md-4 mb-4">
                        <div class="product-card h-100">
                            <div class="product-image">
                                <i class="fas fa-image fa-3x"></i>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fw-bold">@product.Name</h5>
                                <p class="card-text text-muted flex-grow-1">@product.Description</p>
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="product-price">$@product.Price</span>
                                        <small class="text-muted">
                                            <i class="fas fa-warehouse me-1"></i>@product.StockQuantity in stock
                                        </small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary flex-fill"
                                                @onclick="() => ViewProductDetails(product.Id)">
                                            <i class="fas fa-eye me-1"></i>View Details
                                        </button>
                                        <button class="btn btn-success flex-fill"
                                                @onclick="() => AddToCart(product.Id)">
                                            <i class="fas fa-cart-plus me-1"></i>Add to Cart
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    private List<AICleanArchitectureDemo.Application.DTOs.ProductDto> products = new();
    private List<AICleanArchitectureDemo.Application.DTOs.CategoryDto> categories = new();
    private bool isLoading = true;
    private bool isAddingToCart = false;
    private int? selectedCategoryId;

    private IEnumerable<AICleanArchitectureDemo.Application.DTOs.ProductDto> filteredProducts =>
        selectedCategoryId.HasValue
            ? products.Where(p => p.CategoryId == selectedCategoryId.Value)
            : products;

    protected override async Task OnInitializedAsync()
    {
        // Ensure session is initialized during prerender
        var sessionId = GetOrCreateSessionId();
        CartState.SetSessionId(sessionId);
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;

        products = await Mediator.Send(new AICleanArchitectureDemo.Application.Features.Products.Queries.GetProductsQuery());
        categories = await Mediator.Send(new AICleanArchitectureDemo.Application.Features.Categories.Queries.GetCategoriesQuery());

        isLoading = false;
    }

    private void FilterByCategory(int? categoryId)
    {
        selectedCategoryId = categoryId;
    }

    private void ViewProductDetails(int productId)
    {
        Navigation.NavigateTo($"/products/{productId}");
    }

    private async Task AddToCart(int productId)
    {
        try
        {
            // Use session ID that's already set during prerender
            var sessionId = CartState.SessionId ?? GetOrCreateSessionId();

            var command = new AICleanArchitectureDemo.Application.Features.Cart.Commands.AddToCartCommand(sessionId, productId, 1);

            await Mediator.Send(command);

            // In a real app, show a success message
            // For now, just navigate to cart
            Navigation.NavigateTo("/cart");
        }
        catch (Exception ex)
        {
            // Handle error - in a real app, show error message
            Console.WriteLine($"Error adding to cart: {ex.Message}");
        }
    }

    private string GetOrCreateSessionId()
    {
        var httpContext = HttpContextAccessor.HttpContext;
        if (httpContext == null) return Guid.NewGuid().ToString();

        var sessionId = httpContext.Session.GetString("SessionId");
        if (string.IsNullOrEmpty(sessionId))
        {
            sessionId = Guid.NewGuid().ToString();
            httpContext.Session.SetString("SessionId", sessionId);
        }
        return sessionId;
    }
}
